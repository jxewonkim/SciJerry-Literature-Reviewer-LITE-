<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SciJerry Literature Reviewer LITE Ver1.0</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f4f7f9; color: #333; margin: 0; padding: 20px; box-sizing: border-box;
        }
        .main-container {
            display: flex; gap: 30px; width: 100%; max-width: 1600px; margin: 20px auto;
            background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 30px; box-sizing: border-box;
        }
        .control-panel { flex: 1; max-width: 500px; text-align: center; }
        .results-panel { flex: 2; display: flex; flex-direction: column; align-items: center; }
        h1 { font-size: 1.8em; color: #2c3e50; margin-bottom: 10px; }
        .app-description { color: #555; margin-bottom: 30px; }
        .upload-section h2 { font-size: 1.2em; margin-bottom: 10px; color: #34495e; }
        #drop-area {
            border: 2px dashed #bdc3c7; border-radius: 8px; padding: 30px;
            transition: background-color 0.3s, border-color 0.3s; cursor: pointer;
        }
        #drop-area.dragover { border-color: #3498db; background-color: #ecf0f1; }
        #file-name { margin-top: 15px; font-weight: bold; color: #2980b9; word-break: break-all; }
        #file-upload-btn {
            background-color: #3498db; color: white; border: none; padding: 10px 20px;
            border-radius: 6px; cursor: pointer; font-size: 0.9em; margin-top: 15px;
            transition: background-color 0.3s;
        }
        #file-upload-btn:hover { background-color: #2980b9; }
        .button-group { margin-top: 25px; display: flex; flex-direction: column; gap: 12px; }
        .analysis-btn {
            background-color: #2ecc71; color: white; border: none; padding: 12px 20px;
            border-radius: 6px; cursor: pointer; font-size: 1em; transition: background-color 0.3s;
        }
        .analysis-btn:hover { background-color: #27ae60; }
        .analysis-btn:disabled { background-color: #95a5a6; cursor: not-allowed; }
        .results-section {
            text-align: left; width: 100%; height: 100%; display: flex;
            flex-direction: column;
        }
        #loading-spinner {
            display: none; margin-top: 40%; border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
        }
        #loading-text { display: none; margin-top: 20px; color: #555; font-size: 1em; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .warning-message {
            background-color: #fffbe6; border: 1px solid #ffe58f; color: #faad14;
            padding: 10px; border-radius: 6px; margin-bottom: 15px;
        }
        #results-box {
            width: 100%; flex-grow: 1; border: 1px solid #cccccc; border-radius: 8px;
            padding: 25px; overflow-y: auto; background-color: #ffffff; color: #333333;
            font-size: 16px; line-height: 1.7; white-space: pre-wrap; box-sizing: border-box;
        }
        .save-button-group {
            margin-top: 20px; align-self: flex-end; display: flex; gap: 10px;
        }
        .save-btn {
            color: white; border: none; padding: 10px 20px;
            border-radius: 6px; cursor: pointer; font-size: 0.9em;
            transition: opacity 0.3s;
        }
        .save-btn:hover { opacity: 0.8; }
        #save-btn { background-color: #8e44ad; }
        #save-word-btn { background-color: #2980b9; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="control-panel">
            <h1>SciJerry Literature Reviewer LITE Ver1.0</h1>
            <p class="app-description">SciJerry는 여러분의 논문을 분석하고, 체계적으로 리뷰하는 사이트입니다.</p>
            <div class="upload-section">
                <h2>1. 논문(PDF)을 업로드해 주세요</h2>
                <p>✅ 반드시 full-text 형식의 논문(PDF)을 올려주세요.</p>
                <div id="drop-area">
                    <p>논문(PDF)을 드래그 앤 드롭하세요</p><p>또는</p>
                    <button id="file-upload-btn">폴더에서 직접 선택</button>
                    <input type="file" id="file-input" accept=".pdf" hidden>
                    <p id="file-name"></p>
                </div>
            </div>
            <div class="button-group">
                <button class="analysis-btn" id="btn-comprehensive" disabled>논문 종합 분석 시작하기</button>
                <button class="analysis-btn" id="btn-methodology" disabled>논문 방법론 분석 시작하기</button>
                <button class="analysis-btn" id="btn-strobe" disabled>논문 STROBE Statement 분석 시작하기</button>
            </div>
        </div>
        <div class="results-panel" id="results-panel">
            <div id="loading-spinner"></div>
            <p id="loading-text">SciJerry AI가 논문을 분석 중입니다. 이 작업은 2~3분 정도 소요가 됩니다.</p>
            <div class="results-section" id="results-container" style="display: none;">
                <p class="warning-message">⚠️ 안내: 본 문서는 AI가 분석한 논문의 리뷰입니다.</p>
                <div id="results-box"></div>
                <div class="save-button-group">
                    <button class="save-btn" id="save-word-btn">WORD로 저장하기</button>
                    <button class="save-btn" id="save-btn">텍스트로 저장하기</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dropArea = document.getElementById('drop-area');
            const fileInput = document.getElementById('file-input');
            const fileUploadBtn = document.getElementById('file-upload-btn');
            const fileNameDisplay = document.getElementById('file-name');
            const analysisBtns = document.querySelectorAll('.analysis-btn');
            const resultsPanel = document.getElementById('results-panel');
            const loadingSpinner = document.getElementById('loading-spinner');
            const loadingText = document.getElementById('loading-text');
            const resultsContainer = document.getElementById('results-container');
            const resultsBox = document.getElementById('results-box');
            
            const saveBtn = document.getElementById('save-btn');
            const saveWordBtn = document.getElementById('save-word-btn');

            let uploadedFile = null;

            fileUploadBtn.addEventListener('click', () => fileInput.click());
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
            });
            dropArea.addEventListener('dragenter', () => dropArea.classList.add('dragover'));
            dropArea.addEventListener('dragleave', () => dropArea.classList.remove('dragover'));
            dropArea.addEventListener('drop', handleDrop, false);
            fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

            function handleDrop(e) {
                dropArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            }

            function handleFiles(files) {
                if (files.length > 0 && files[0].type === 'application/pdf') {
                    uploadedFile = files[0];
                    fileNameDisplay.textContent = `선택된 파일: ${uploadedFile.name}`;
                    analysisBtns.forEach(btn => btn.disabled = false);
                    resultsContainer.style.display = 'none';
                    loadingSpinner.style.display = 'none';
                    loadingText.style.display = 'none';
                } else {
                    alert('PDF 파일만 업로드할 수 있습니다.');
                }
            }

            analysisBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    if (uploadedFile) {
                        startAnalysis(btn.id.split('-')[1]);
                    } else {
                        alert('먼저 논문 파일을 업로드해주세요.');
                    }
                });
            });

            function startAnalysis(type) {
                resultsContainer.style.display = 'none';
                loadingSpinner.style.display = 'block';
                loadingText.style.display = 'block';
                analysisBtns.forEach(btn => btn.disabled = true);
                const formData = new FormData();
                formData.append('file', uploadedFile);
                formData.append('analysisType', type);
                fetch('http://127.0.0.1:5000/analyze', { method: 'POST', body: formData })
                .then(response => {
                    if (!response.ok) { throw new Error('서버 응답 오류'); }
                    return response.json();
                })
                .then(data => {
                    if (data.analysis_result) {
                        let rawText = data.analysis_result;
                        let formattedHtml = rawText.replace(/\n/g, '<br>');
                        formattedHtml = formattedHtml.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        formattedHtml = formattedHtml.replace(/\*(.*?)\*/g, '<em>$1</em>');
                        resultsBox.innerHTML = formattedHtml;
                    } else if (data.error) {
                        resultsBox.innerText = `오류: ${data.error}`;
                    }
                })
                .catch(error => {
                    console.error('분석 요청 실패:', error);
                    resultsBox.innerText = `분석 요청에 실패했습니다. 백엔드 서버가 실행 중인지 확인해주세요.\n오류: ${error.message}`;
                })
                .finally(() => {
                    loadingSpinner.style.display = 'none';
                    loadingText.style.display = 'none';
                    resultsContainer.style.display = 'flex';
                    analysisBtns.forEach(btn => btn.disabled = false);
                });
            }

            saveBtn.addEventListener('click', () => {
                const textToSave = resultsBox.innerText;
                const blob = new Blob([textToSave], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'SciJerry-result.txt';
                a.click();
                URL.revokeObjectURL(a.href);
            });

            saveWordBtn.addEventListener('click', () => {
                let header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' "+
                    "xmlns:w='urn:schemas-microsoft-com:office:word' "+
                    "xmlns='http://www.w3.org/TR/REC-html40'>"+
                    "<head><meta charset='utf-8'><title>Export HTML to Word</title></head><body>";
                let footer = "</body></html>";
                let sourceHTML = header + resultsBox.innerHTML + footer;
                
                let source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
                let fileDownload = document.createElement("a");
                document.body.appendChild(fileDownload);
                fileDownload.href = source;
                fileDownload.download = 'SciJerry-result.doc';
                fileDownload.click();
                document.body.removeChild(fileDownload);
            });

        });
    </script>
</body>
</html>